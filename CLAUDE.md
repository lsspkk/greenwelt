# Plant Courier - WASM/Pygbag Project

## Project Structure

```
plant_courier_minimal/
├── src/                    # Main game source (pygbag entry point)
│   ├── main.py             # Entry point - must be named main.py
│   ├── esper/              # Bundled ECS library
│   ├── assets/             # Game assets
│   ├── data/               # Game data (TOML files)
│   └── requirements.txt    # Dependencies for pygbag
├── docs/                   # GitHub Pages output (generated by build.py)
├── build.py                # Build script for WASM deployment
├── pygbag_official_example/ # Reference working example
└── CLAUDE.md
```

## Build Commands

```bash
# Build for GitHub Pages (outputs to docs/)
python build.py

# Build and run local test server
python build.py --serve

# Clean build artifacts
python build.py --clean
```

## GitHub Pages Deployment

1. Run `python build.py` to generate the `docs/` folder
2. Commit and push the `docs/` folder to your repository
3. Go to repository Settings > Pages
4. Set Source to "Deploy from a branch"
5. Select branch `main` and folder `/docs`
6. Save and wait for deployment

## WASM/Pygbag Critical Requirements

### 1. Bundle Third-Party Libraries Directly

**Pygbag does NOT reliably load packages from PyPI at runtime.** Even if the console shows packages being fetched, they may not be mounted in time for import.

**Solution:** Copy the library source directly into your project folder:

```bash
# Example: bundling esper
cp -r .venv/lib/python3.12/site-packages/esper/ src/esper/
```

Then remove from `requirements.txt` since it's now bundled.

**Libraries confirmed to need bundling:**
- `esper` - ECS library (pure Python, works when bundled)

**Libraries that work via requirements.txt:**
- `pygame-ce` - handled specially by pygbag
- `tomli` - TOML parser (fetched from pygbag repo)

### 2. Async Main Loop Pattern

The main game loop MUST be async and yield control:

```python
import asyncio
import pygame

async def main():
    pygame.init()
    screen = pygame.display.set_mode((480, 320))
    clock = pygame.time.Clock()

    running = True
    while running:
        dt = clock.tick(60) / 1000.0
        for e in pygame.event.get():
            if e.type == pygame.QUIT:
                running = False

        # Game logic here

        pygame.display.flip()
        await asyncio.sleep(0)  # CRITICAL: yield to browser

if __name__ == '__main__':
    asyncio.run(main())
```

### 3. Entry Point Must Be `main.py`

Pygbag looks for `main.py` in the root of the packaged folder.

### 4. Build and Test Commands

```bash
cd src/

# Build only (creates build/web/)
.venv/bin/python -m pygbag --build .

# Build and run test server (http://localhost:8000)
.venv/bin/python -m pygbag .
```

### 5. Avoid Print Statements in Production

Print statements severely degrade WASM performance. Remove all debug `print()` calls before deployment.

### 6. File Path Handling

`Path(__file__)` works but paths resolve differently in WASM. Test file loading in browser.

## Debugging WASM Issues

When something doesn't work in browser but works locally:

1. **Check browser console (F12)** for JavaScript errors
2. **Render debug info on screen** - Python print() may not appear in browser console
3. **Test imports individually** with try/except and display results on pygame surface
4. **Bundle the library locally** if import fails with "ModuleNotFoundError"

## Working Configuration

As of January 2026, this configuration works:
- Python 3.12
- pygame-ce >= 2.5.0
- pygbag >= 0.9.2
- esper 3.4 (bundled locally)
- tomli >= 2.0.1 (via requirements.txt)
